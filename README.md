# Vs. Dungeons — Digital GM Toolkit

A tablet-optimized web application for running tabletop RPG sessions. Two core screens: a **Character Sheet Manager** (with skill trees) and a **Combat Tracker** powered by Claude AI voice input, plus a **Post-Battle Rewards System** for XP, gold, and loot.

Built for a single GM running sessions with two kids using minifigures on a physical table, with an iPad as the digital companion.

---

## Tech Stack

| Layer | Technology | Purpose |
|-------|-----------|---------|
| **Frontend** | Next.js 16 (App Router) | React framework, SSR, tablet PWA |
| **UI** | Tailwind CSS 4 + shadcn/ui | Dark fantasy theme, tablet-first |
| **State** | Zustand 5 | Client state for combat + skill trees |
| **Database** | Supabase (PostgreSQL) | Characters, monsters, combat logs, skills |
| **AI Engine** | Claude API (claude-sonnet-4-5-20250929) | Combat resolution + narration |
| **Voice Input** | Web Speech API | Browser-native speech-to-text |
| **Voice Output** | Web Speech Synthesis API | Optional narration read-aloud |
| **Hosting** | GCP Cloud Run | Container hosting via Docker |
| **CI/CD** | GitHub Actions | Lint + build on push, auto-deploy to Cloud Run |

---

## Features

### Character Sheet
- Full stat block with point-buy allocation
- Profession-based abilities (knight, ranger, wizard, healer, rogue, inventor)
- Inventory management with equipped items
- XP tracking with level-up and rank progression

### Skill Trees (WoW-classic style)
- Warrior: Protection + Arms branches (52 skills)
- Rogue/Ranger: Shadow + Precision + Survival branches (75 skills)
- Tier-gated progression (0/3/6/10/15 points per tier)
- 5-slot action bar for active abilities
- Free respec anytime

### Combat Tracker
- Voice input or text commands resolved by Claude AI
- Initiative tracking with automatic turn order
- HP, resource (rage/energy/mana), and status effect management
- Cinematic narration generated by Claude
- Critical hits, multi-target abilities, defend/help actions

### Post-Battle Rewards
- Per-monster XP values, split evenly among heroes
- GM assigns gold and items from searchable item catalog
- Level-up celebration overlay with stat/skill point notifications
- All rewards persist to character profiles

### GM Config Dashboard
- Adjustable stat formulas, XP thresholds, combat rules
- Loot tables, ability costs, resource regen rates

---

## Repository Structure

```
Vs.-Dungeons/
├── .github/workflows/
│   ├── ci.yml                              # Lint + build on push
│   └── deploy.yml                          # GCP Cloud Run deploy
├── docs/
│   ├── ARCHITECTURE.md                     # System architecture & data flow
│   ├── DATABASE.md                         # Supabase schema & migrations
│   ├── DEPLOYMENT.md                       # GCP + Supabase setup guide
│   ├── FEATURE-CHARACTER-SHEET.md          # Character sheet spec
│   ├── FEATURE-COMBAT-TRACKER.md           # Combat tracker spec
│   ├── FEATURE-GM-CONFIG.md                # GM config spec
│   ├── CLAUDE-API-INTEGRATION.md           # Claude API + voice pipeline
│   ├── STATUS-EFFECTS.md                   # Status effect reference
│   ├── GAME-RULES-REFERENCE.md             # Rules injected into Claude context
│   ├── SKILL-TREES-API-RULES.md            # Skill tree rules for Claude
│   └── SKILL-TREES-UI-SPEC.md              # Skill tree UI component spec
├── game-rules/                             # Source-of-truth game system
│   ├── core-rules.md
│   ├── spellbook.md
│   ├── character-sheets.md
│   ├── campaign-log.md
│   └── game-master-prompt.md
├── supabase/
│   ├── migrations/
│   │   ├── 001_initial_schema.sql          # Core tables + RLS
│   │   ├── 002_rls_policies.sql            # Row-level security
│   │   ├── 003_atomic_xp.sql              # increment_xp() function
│   │   ├── 004_skill_trees.sql            # Skill tree tables + functions
│   │   └── 005_rewards_system.sql         # Rewards, item catalog, XP
│   └── seed/
│       ├── 002_monsters.sql               # Monster library (23 monsters)
│       ├── 003_abilities.sql              # Profession abilities
│       ├── 004_status_effects.sql         # Effect definitions
│       ├── 005_skill_tree_warrior.sql     # 52 warrior skills
│       ├── 006_skill_tree_rogue_ranger.sql # 75 rogue/ranger skills
│       ├── 007_monster_xp_values.sql      # XP rewards per monster
│       └── 008_item_catalog.sql           # ~25 items for GM quick-pick
├── src/
│   ├── app/
│   │   ├── layout.tsx                     # Root layout
│   │   ├── page.tsx                       # Home / campaign selector
│   │   ├── api/combat/action/route.ts     # Claude API route handler
│   │   ├── character/
│   │   │   ├── page.tsx                   # Character list
│   │   │   └── [id]/page.tsx             # Character sheet + skill trees
│   │   ├── combat/
│   │   │   ├── page.tsx                   # Combat tracker + rewards
│   │   │   └── setup/page.tsx            # Encounter setup
│   │   └── config/page.tsx               # GM config dashboard
│   ├── components/
│   │   ├── ui/                           # shadcn/ui primitives
│   │   ├── character/
│   │   │   ├── skill-tree-panel.tsx       # Skill tree container
│   │   │   ├── skill-tree-branch.tsx      # Tier-grouped skill list
│   │   │   ├── skill-node.tsx            # Individual skill card
│   │   │   ├── skill-point-summary.tsx   # Points bar + respec
│   │   │   └── action-bar.tsx            # 5-slot action bar
│   │   └── combat/
│   │       ├── rewards-screen.tsx        # Post-battle rewards UI
│   │       └── level-up-celebration.tsx   # Level-up overlay
│   ├── lib/
│   │   ├── auth/
│   │   │   ├── validate-key.ts           # API key validation
│   │   │   └── rate-limit.ts             # In-memory rate limiting
│   │   ├── claude/
│   │   │   ├── client.ts                 # Claude API wrapper
│   │   │   ├── combat-prompt.ts          # System prompt builder
│   │   │   ├── action-parser.ts          # Response → game state
│   │   │   ├── schemas.ts               # Zod validation schemas
│   │   │   └── validate-response.ts      # Game logic validation
│   │   ├── game/
│   │   │   ├── stats.ts                  # Stat calculations
│   │   │   ├── combat.ts                 # Combat resolution helpers
│   │   │   ├── rewards.ts               # XP split + level-up logic
│   │   │   ├── resources.ts             # Resource regen/spend
│   │   │   ├── status-effects.ts        # Effect tick/removal
│   │   │   ├── loot.ts                  # Loot table roller
│   │   │   └── config.ts               # Game config defaults
│   │   ├── supabase/
│   │   │   ├── client.ts                # Browser client
│   │   │   ├── server.ts               # Server client
│   │   │   └── queries.ts              # All DB queries
│   │   └── voice/
│   │       ├── speech-recognition.ts    # Web Speech API wrapper
│   │       └── speech-synthesis.ts      # TTS for narration
│   ├── stores/
│   │   ├── combat-store.ts             # Combat state (Zustand)
│   │   ├── character-store.ts          # Character editing
│   │   ├── config-store.ts             # GM config
│   │   └── skill-tree-store.ts         # Skill allocation
│   └── types/
│       ├── game.ts                     # Core types
│       ├── combat.ts                   # Combat types
│       ├── config.ts                   # Config types
│       └── rewards.ts                  # Reward types
├── Dockerfile                          # GCP Cloud Run container
├── .dockerignore                       # Excludes .git, node_modules, docs
├── package.json
├── tsconfig.json
└── .env.example                        # Environment template
```

---

## Quick Start

```bash
# Clone
git clone https://github.com/bclark/Vs.-Dungeons.git
cd Vs.-Dungeons

# Install
npm install

# Set up environment
cp .env.example .env.local
# Fill in: Supabase URL/key, Anthropic API key, APP_SECRET_KEY

# Dev server
npm run dev

# Open on iPad: http://YOUR_LOCAL_IP:3000
```

---

## Environment Variables

```env
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key

# Anthropic
ANTHROPIC_API_KEY=sk-ant-your-key

# App
NEXT_PUBLIC_APP_URL=http://localhost:3000

# API Security (generate with: openssl rand -hex 32)
APP_SECRET_KEY=your-secret
NEXT_PUBLIC_APP_KEY=your-secret  # same value, sent by client
```

---

## Database Setup

Run migrations and seed data in the Supabase SQL editor, in order:

**Migrations (run first):**
1. `supabase/migrations/001_initial_schema.sql`
2. `supabase/migrations/002_rls_policies.sql`
3. `supabase/migrations/003_atomic_xp.sql`
4. `supabase/migrations/004_skill_trees.sql`
5. `supabase/migrations/005_rewards_system.sql`

**Seed data (run after migrations):**
1. `supabase/seed/002_monsters.sql`
2. `supabase/seed/003_abilities.sql`
3. `supabase/seed/004_status_effects.sql`
4. `supabase/seed/005_skill_tree_warrior.sql`
5. `supabase/seed/006_skill_tree_rogue_ranger.sql`
6. `supabase/seed/007_monster_xp_values.sql`
7. `supabase/seed/008_item_catalog.sql`

---

## Deployment

Deployed to **GCP Cloud Run** via GitHub Actions. Push to `main` triggers:
1. CI: lint + build check
2. Deploy: Docker build → Artifact Registry → Cloud Run

See [docs/DEPLOYMENT.md](docs/DEPLOYMENT.md) for full setup guide.

---

## Documentation

| Document | Description |
|----------|-------------|
| [ARCHITECTURE.md](docs/ARCHITECTURE.md) | System architecture, data flow, tech decisions |
| [DATABASE.md](docs/DATABASE.md) | Full Supabase schema, migrations, relationships |
| [DEPLOYMENT.md](docs/DEPLOYMENT.md) | GCP Cloud Run + Supabase + GitHub Actions |
| [FEATURE-CHARACTER-SHEET.md](docs/FEATURE-CHARACTER-SHEET.md) | Character sheet feature spec |
| [FEATURE-COMBAT-TRACKER.md](docs/FEATURE-COMBAT-TRACKER.md) | Combat tracker + rewards spec |
| [FEATURE-GM-CONFIG.md](docs/FEATURE-GM-CONFIG.md) | GM config dashboard spec |
| [CLAUDE-API-INTEGRATION.md](docs/CLAUDE-API-INTEGRATION.md) | Claude API + voice pipeline |
| [STATUS-EFFECTS.md](docs/STATUS-EFFECTS.md) | Status effect system reference |
| [GAME-RULES-REFERENCE.md](docs/GAME-RULES-REFERENCE.md) | Rules for Claude context window |
| [SKILL-TREES-API-RULES.md](docs/SKILL-TREES-API-RULES.md) | Skill tree rules for Claude |
| [SKILL-TREES-UI-SPEC.md](docs/SKILL-TREES-UI-SPEC.md) | Skill tree UI component spec |
| [SKILL-TREE-PROGRESS.md](SKILL-TREE-PROGRESS.md) | Skill tree implementation tracker |

---

## Security

| Concern | Approach |
|---------|----------|
| Claude API key | Server-side only via Next.js API routes |
| API auth | `APP_SECRET_KEY` header validation on combat action route |
| Rate limiting | 10 requests/minute per IP (in-memory) |
| Input validation | Zod schemas on all API inputs |
| Response validation | Schema + game logic checks on Claude responses |
| Supabase access | Anon key with permissive RLS (single-user app) |
| Voice data | Processed locally in browser, text only sent to Claude |

---

## Design

- Dark fantasy theme (#1a1a2e background, #e5a91a gold accents, #0f3460 panels)
- Tablet-first: large touch targets, landscape orientation
- Physical minifig tokens at the table — app tracks state, not replaces play
